# CNC OEE 모니터링 시스템 - 데이터베이스 구현 완료

## 구현 완료 사항

### 2.1 PostgreSQL 테이블 생성 및 관계 설정 ✅

#### 생성된 테이블
1. **user_profiles** - 사용자 프로필 관리
   - 역할 기반 접근 제어 (admin, operator, engineer)
   - 담당 설비 배정 기능
   - 활성/비활성 상태 관리

2. **machines** - 설비 마스터 데이터
   - 고유 설비명 제약조건
   - 기본 Tact Time 설정
   - 위치 및 모델 정보 관리

3. **machine_logs** - 설비 상태 로그
   - 7가지 설비 상태 지원
   - 시간 중복 방지 제약조건
   - 운영자 추적 기능

4. **production_records** - 생산 실적 데이터
   - 교대별 실적 관리
   - OEE 지표 저장
   - 데이터 무결성 제약조건

5. **audit_log** - 감사 로그 (보안 강화)
   - 중요 데이터 변경 추적
   - 역할 변경 감사

#### 구현된 제약조건
- 외래키 관계 설정 (CASCADE, SET NULL)
- 데이터 유효성 검증 (양수, 범위 체크)
- 중복 방지 (설비명, 일일 실적)
- 시간 논리 검증 (종료시간 > 시작시간)

#### 성능 최적화 인덱스
- 설비별 시간 순 조회 최적화
- 날짜별 실적 조회 최적화
- 역할별 사용자 조회 최적화
- OEE 지표 정렬 최적화

### 2.2 Row Level Security (RLS) 정책 구현 ✅

#### 역할별 접근 권한
1. **관리자 (admin)**
   - 모든 데이터 접근 및 관리 권한
   - 사용자 계정 생성/수정/삭제
   - 설비 마스터 데이터 관리
   - 감사 로그 조회

2. **엔지니어 (engineer)**
   - 모든 설비 데이터 조회 권한
   - 설비 정보 수정 권한
   - 모든 생산 실적 분석 권한

3. **운영자 (operator)**
   - 담당 설비만 접근 가능
   - 본인이 입력한 데이터만 수정 가능
   - 본인 프로필 조회/수정

#### 보안 정책
- 비활성 사용자 접근 차단
- 데이터 수정 시 작성자 검증
- 역할 변경 시 감사 로그 생성
- 자동 운영자 ID 설정

## 추가 구현 기능

### 유틸리티 함수
1. **get_machine_current_state()** - 설비 현재 상태 조회
2. **calculate_oee()** - OEE 지표 실시간 계산
3. **close_previous_machine_log()** - 설비 상태 변경 시 이전 로그 자동 종료

### 데이터베이스 뷰
1. **machine_current_status** - 설비 현재 상태 요약
2. **daily_oee_summary** - 일일 OEE 요약

### 자동화 트리거
1. **updated_at 자동 업데이트** - 데이터 수정 시간 추적
2. **운영자 ID 자동 설정** - 로그 생성 시 작성자 자동 기록
3. **이전 로그 자동 종료** - 설비 상태 변경 시 중복 방지
4. **역할 변경 감사** - 보안 중요 변경사항 추적

## 사용 방법

1. Supabase 프로젝트의 SQL Editor에서 `supabase-setup.sql` 파일 실행
2. 관리자 계정으로 로그인 후 초기 설비 및 사용자 데이터 입력
3. 각 역할별 사용자에게 적절한 권한 부여

## 보안 고려사항

- 모든 테이블에 RLS 활성화
- 역할 기반 세밀한 접근 제어
- 데이터 변경 감사 추적
- SQL 인젝션 방지 (매개변수화된 쿼리)
- 민감한 작업에 대한 SECURITY DEFINER 함수 사용

이제 데이터베이스 스키마와 보안 정책이 완전히 구현되어 애플리케이션 개발을 시작할 수 있습니다.